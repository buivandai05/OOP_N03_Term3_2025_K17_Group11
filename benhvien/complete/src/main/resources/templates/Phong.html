<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>üè• Qu·∫£n L√Ω Ph√≤ng ƒêi·ªÅu Tr·ªã</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f8f9fa;
        overflow-x: hidden;
      }
      .sidebar {
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        width: 240px;
        background-color: #343a40;
        color: #fff;
      }
      .sidebar a {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 15px 20px;
      }
      .sidebar a:hover {
        background-color: #495057;
      }
      .content {
        margin-left: 240px;
        padding: 40px;
      }
      h2 {
        text-align: center;
        margin-bottom: 30px;
      }
      .card {
        margin-bottom: 20px;
      }
      input,
      button {
        border-radius: 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h3 class="text-center py-4">üè• Qu·∫£n L√Ω BV</h3>
      <a href="/">üè† Trang Ch·ªß</a>
      <a href="/benhnhan">üßë‚Äçü§ù‚Äçüßë Qu·∫£n L√Ω B·ªánh Nh√¢n</a>
      <a href="/phong" style="background-color: #495057;">üè• Qu·∫£n L√Ω Ph√≤ng</a>
      <a href="/bacsi">üë®‚Äç‚öïÔ∏è Qu·∫£n L√Ω B√°c Sƒ©</a>
      <a href="/hoso">üìÑ Xem H·ªì S∆° B·ªánh Nh√¢n</a>
    </div>

<!-- Content -->
<div class="content">
  <h2>üè• H·ªÜ TH·ªêNG QU·∫¢N L√ù PH√íNG ƒêI·ªÄU TR·ªä</h2>

  <!-- Row 1: Form Th√™m Ph√≤ng + G√°n B·ªánh Nh√¢n -->
  <div class="row mb-4">
    <!-- Form Th√™m / S·ª≠a Ph√≤ng -->
    <div class="col-md-7">
      <div class="card shadow-sm p-4">
        <h5 class="card-title mb-3" id="formTitle">Th√™m Ph√≤ng M·ªõi</h5>
        <form id="formAddRoom">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <input type="text" class="form-control" placeholder="M√£ Ph√≤ng" id="maPhong" required>
            </div>
            <div class="col-md-6">
              <input type="text" class="form-control" placeholder="T√™n Ph√≤ng" id="tenPhong" required>
            </div>
            <div class="col-md-6">
              <input type="text" class="form-control" placeholder="Khoa" id="khoa" required>
            </div>
            <div class="col-md-4">
              <input type="number" class="form-control" placeholder="S·ª©c Ch·ª©a" id="sucChua" required>
            </div>
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Form G√°n B·ªánh Nh√¢n V√†o Ph√≤ng -->
    <div class="col-md-5">
      <div class="card shadow-sm p-4">
        <h5 class="card-title mb-3">Th√™m B·ªánh Nh√¢n V√†o Ph√≤ng</h5>
        <form id="formAssignPatient">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <input type="text" class="form-control" placeholder="M√£ Ph√≤ng" id="assignMaPhong" required>
            </div>
            <div class="col-md-6">
              <input type="text" class="form-control" placeholder="M√£ B·ªánh Nh√¢n" id="assignMaBenhNhan" required>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-success">Th√™m B·ªánh Nh√¢n</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Row 2: Danh S√°ch Ph√≤ng ƒêi·ªÅu Tr·ªã -->
  <div class="card shadow-sm p-4">
    <h5 class="card-title mb-3">Danh S√°ch Ph√≤ng ƒêi·ªÅu Tr·ªã</h5>
    <table class="table table-bordered table-striped" id="tblRooms">
      <thead class="table-dark">
        <tr>
          <th>M√£</th>
          <th>T√™n</th>
          <th>Khoa</th>
          <th>S·ª©c Ch·ª©a</th>
          <th>Tr·ªëng</th>
          <th>H√†nh ƒê·ªông</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


    <!-- Modal hi·ªÉn th·ªã danh s√°ch b·ªánh nh√¢n -->
    <div class="modal fade" id="modalPatients" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Danh S√°ch B·ªánh Nh√¢n</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <div class="modal-body">
            <table class="table table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>M√£ B·ªánh Nh√¢n</th>
                  <th>T√™n B·ªánh Nh√¢n</th>
                  <th>Tu·ªïi</th>
                  <th>Gi·ªõi T√≠nh</th>
                  <th>ƒê·ªãa Ch·ªâ</th>
                  <th>ƒêi·ªán Tho·∫°i</th>
                  <th>Chu·∫©n ƒêo√°n</th>
                  <th>H√†nh ƒê·ªông</th>
                </tr>
              </thead>
              <tbody id="modalPatientsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API = "/api/phong";
      const form = document.getElementById("formAddRoom");
      const tbl = document.getElementById("tblRooms").querySelector("tbody");
      const formAssign = document.getElementById("formAssignPatient");
      const formTitle = document.getElementById("formTitle");

      let isEdit = false;
      let editMaPhong = "";

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          maPhong: document.getElementById("maPhong").value.trim(),
          tenPhong: document.getElementById("tenPhong").value.trim(),
          khoa: document.getElementById("khoa").value.trim(),
          sucChua: parseInt(document.getElementById("sucChua").value),
        };

        let res, msg;
        if (isEdit) {
          res = await fetch(`${API}/${editMaPhong}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          msg = await res.text();
        } else {
          res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          msg = await res.text();
        }

        alert(msg);
        resetForm();
        loadRooms();
      });

      async function loadRooms() {
        const res = await fetch(API);
        const rooms = await res.json();
        tbl.innerHTML = "";
        rooms.forEach((r) => {
          tbl.innerHTML += `<tr>
        <td>${r.maPhong}</td>
        <td>${r.tenPhong}</td>
        <td>${r.khoa}</td>
        <td>${r.sucChua}</td>
        <td>${r.soGiuongTrong}</td>
        <td>
          <button class="btn btn-sm btn-info me-1" onclick='viewPatients("${
            r.maPhong
          }")'>Xem B·ªánh Nh√¢n</button>
          <button class="btn btn-sm btn-warning me-1" onclick='editRoom(${JSON.stringify(
            r
          )})'>S·ª≠a</button>
          <button class="btn btn-sm btn-danger" onclick='deleteRoom("${
            r.maPhong
          }")'>Xo√°</button>
        </td>
      </tr>`;
        });
      }

      function editRoom(r) {
        isEdit = true;
        editMaPhong = r.maPhong;
        formTitle.textContent = "C·∫≠p Nh·∫≠t Ph√≤ng";
        document.getElementById("maPhong").value = r.maPhong;
        document.getElementById("tenPhong").value = r.tenPhong;
        document.getElementById("khoa").value = r.khoa;
        document.getElementById("sucChua").value = r.sucChua;

        document.getElementById("maPhong").readOnly = true;
      }

      async function deleteRoom(ma) {
        if (confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° ph√≤ng ${ma}?`)) {
          const res = await fetch(`${API}/${ma}`, { method: "DELETE" });
          const msg = await res.text();
          alert(msg);
          loadRooms();
        }
      }

      function resetForm() {
        isEdit = false;
        editMaPhong = "";
        formTitle.textContent = "Th√™m Ph√≤ng M·ªõi";
        form.reset();
        document.getElementById("maPhong").readOnly = false;
      }

      formAssign.addEventListener("submit", async (e) => {
        e.preventDefault();
        const maPhong = document.getElementById("assignMaPhong").value.trim();
        const maBenhNhan = document
          .getElementById("assignMaBenhNhan")
          .value.trim();

        const res = await fetch(
          `${API}/${maPhong}/gan-benh-nhan?maBenhNhan=${maBenhNhan}`,
          {
            method: "POST",
          }
        );

        const msg = await res.text();
        alert(msg);
        formAssign.reset();
      });

      loadRooms();

      async function viewPatients(maPhong) {
        const res = await fetch(`${API}/${maPhong}`);
        const phong = await res.json();

        const modalTitle = document.querySelector(
          "#modalPatients .modal-title"
        );
        const modalBody = document.getElementById("modalPatientsBody");

        modalTitle.textContent = `Danh S√°ch B·ªánh Nh√¢n - ${phong.tenPhong}`;
        modalBody.innerHTML = "";

        if (!phong.dsBenhNhan || phong.dsBenhNhan.length === 0) {
          modalBody.innerHTML =
            '<tr><td colspan="8" class="text-center text-muted">Ch∆∞a c√≥ b·ªánh nh√¢n.</td></tr>';
        } else {
          phong.dsBenhNhan.forEach((bn) => {
            modalBody.innerHTML += `
          <tr>
            <td>${bn.maBenhNhan}</td>
            <td>${bn.tenBenhNhan}</td>
            <td>${bn.tuoi}</td>
            <td>${bn.gioiTinh}</td>
            <td>${bn.diaChi}</td>
            <td>${bn.soDienThoai}</td>
            <td>${bn.chuanDoan}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="removeBenhNhan('${maPhong}', '${bn.maBenhNhan}')">Xo√°</button>
            </td>
          </tr>`;
          });
        }

        const modal = new bootstrap.Modal(
          document.getElementById("modalPatients")
        );
        modal.show();
      }

      async function removeBenhNhan(maPhong, maBenhNhan) {
        if (
          confirm(`X√°c nh·∫≠n xo√° b·ªánh nh√¢n ${maBenhNhan} kh·ªèi ph√≤ng ${maPhong}?`)
        ) {
          const res = await fetch(
            `${API}/${maPhong}/xoa-benh-nhan?maBenhNhan=${maBenhNhan}`,
            {
              method: "DELETE",
            }
          );

          const msg = await res.text();
          alert(msg);
          viewPatients(maPhong);
        }
      }
    </script>
  </body>
</html>
